<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.drvlg.domain.vehicle.mapper.VehicleMapper">

  <insert id="insertVehicle">
    INSERT INTO VEHICLE (
      user_id, license_plate, make, model, year, nickname, initial_odometer, created_at, updated_at
    ) VALUES (
               #{userId}, #{licensePlate}, #{make}, #{model}, #{year}, #{nickName}, #{initialOdometer}, NOW(), NOW()
             )
  </insert>

  <select id="selectVehiclesByUserId" resultType="com.example.drvlg.domain.vehicle.vo.VehicleVO">
    SELECT
      v.vehicle_id,
      v.user_id,
      v.license_plate,
      v.make,
      v.model,
      v.year,
      v.nickname,
      v.initial_odometer,
      COALESCE(
              (SELECT MAX(odometer)
               FROM (
                      SELECT odometer FROM FUEL_RECORD WHERE vehicle_id = v.vehicle_id
                      UNION ALL
                      SELECT odometer FROM MAINTENANCE_RECORD WHERE vehicle_id = v.vehicle_id
                    ) AS combined_odometers),
              v.initial_odometer
      ) AS currentOdometer,
      v.created_at,
      v.updated_at
    FROM
      VEHICLE v
    WHERE
      v.user_id = #{userId}
  </select>

  <select id="selectVehicleById" resultType="com.example.drvlg.domain.vehicle.vo.VehicleVO">
    SELECT
      v.vehicle_id,
      v.user_id,
      v.license_plate,
      v.make,
      v.model,
      v.year,
      v.nickname,
      v.initial_odometer,
      v.created_at,
      v.updated_at
    FROM
      VEHICLE v
    WHERE
      v.vehicle_id = #{vehicleId}
  </select>

  <delete id="deleteVehicle">
    DELETE FROM VEHICLE
    WHERE vehicle_id = #{vehicleId}
  </delete>

  <update id="updateVehicle">
    UPDATE VEHICLE
    SET
      license_plate = #{licensePlate},
      make = #{make},
      model = #{model},
      year = #{year},
      nickname = #{nickName},
      initial_odometer = #{initialOdometer},
      updated_at = NOW()
    WHERE
      vehicle_id = #{vehicleId}
  </update>

</mapper>