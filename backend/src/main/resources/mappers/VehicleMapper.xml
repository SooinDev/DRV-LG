<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.drvlg.mapper.VehicleMapper">

  <insert id="insertVehicle">
    INSERT INTO VEHICLE (
      user_id, license_plate, make, model, year, nickname, initial_odometer, created_at, updated_at
    ) VALUES (
               #{userId}, #{number}, #{maker}, #{model}, #{year}, #{nickName}, #{initOdo}, NOW(), NOW()
             )
  </insert>

  <select id="selectVehiclesByUserId" resultType="com.example.drvlg.vo.VehicleVO">
    SELECT
      v.vehicle_id AS vehicleId,
      v.user_id AS userId,
      v.license_plate AS number,
      v.make AS maker,
      v.model,
      v.year,
      v.nickname AS nickName,
      v.initial_odometer AS initOdo,
      COALESCE(
        (SELECT MAX(odometer)
         FROM (
           SELECT odometer FROM FUEL_RECORD WHERE vehicle_id = v.vehicle_id
           UNION ALL
           SELECT odometer FROM MAINTENANCE_RECORD WHERE vehicle_id = v.vehicle_id
         ) AS combined_odometers),
        v.initial_odometer
      ) AS currentOdometer,
      v.created_at AS registerDate,
      v.updated_at AS updateDate
    FROM
      VEHICLE v
    WHERE
      v.user_id = #{userId}
  </select>

  <select id="selectLatestOdometer" resultType="java.lang.Integer">
    SELECT MAX(odometer)
    FROM (
           SELECT odometer FROM FUEL_RECORD WHERE vehicle_id = #{vehicleId}
           UNION ALL
           SELECT odometer FROM MAINTENANCE_RECORD WHERE vehicle_id = #{vehicleId}
         ) AS combined_odometers
  </select>

  <select id="selectVehicleById" resultType="com.example.drvlg.vo.VehicleVO">
    SELECT
      v.vehicle_id AS vehicleId,
      v.user_id AS userId,
      v.license_plate AS number,
      v.make AS maker,
      v.model,
      v.year,
      v.nickname AS nickName,
      v.initial_odometer AS initOdo,
      COALESCE(
        (SELECT MAX(odometer)
         FROM (
           SELECT odometer FROM FUEL_RECORD WHERE vehicle_id = v.vehicle_id
           UNION ALL
           SELECT odometer FROM MAINTENANCE_RECORD WHERE vehicle_id = v.vehicle_id
         ) AS combined_odometers),
        v.initial_odometer
      ) AS currentOdometer,
      v.created_at AS registerDate,
      v.updated_at AS updateDate
    FROM
      VEHICLE v
    WHERE
      v.vehicle_id = #{vehicleId}
  </select>

  <delete id="deleteVehicle">
    DELETE FROM VEHICLE
    WHERE vehicle_id = #{vehicleId}
  </delete>

  <update id="updateVehicle">
    UPDATE VEHICLE
    SET
      license_plate = #{number},
      make = #{maker},
      model = #{model},
      year = #{year},
      nickname = #{nickName},
      initial_odometer = #{initOdo},
      updated_at = NOW()
    WHERE
      vehicle_id = #{vehicleId}
  </update>

</mapper>